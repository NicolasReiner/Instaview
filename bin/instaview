#!/usr/bin/env ruby
# frozen_string_literal: true

require 'json'
require 'stringio'
require_relative "../lib/instaview"

def show_usage
  puts "Usage: instaview <username|test> [method]"
  puts "Methods:"
  puts "  selenium (default) - Full browser automation with Selenium"
  puts "  http              - Simple HTTP method using curl"
  puts ""
  puts "Examples:"
  puts "  instaview test                      # Test gem functionality"
  puts "  instaview instagram"
  puts "  instaview instagram selenium"
  puts "  instaview instagram http"
end

username = ARGV[0]
method = ARGV[1] || "selenium"

if username.nil? || username.empty?
  show_usage
  exit 1
end

# Special case for testing
if username == "test"
  begin
    Instaview.test_connectivity
    exit 0
  rescue => e
    puts "Test failed: #{e.message}"
    exit 1
  end
end

unless %w[selenium http].include?(method)
  puts "Invalid method: #{method}"
  show_usage
  exit 1
end

begin
  # Try cache-only first (12h TTL)
  cached = Instaview.load_from_cache_only(username)
  if cached
    puts JSON.pretty_generate(cached)
    exit 0
  end

  # Helper to silence noisy library logs and only print final JSON
  def silence_output
    orig_out, orig_err = $stdout, $stderr
    $stdout = StringIO.new
    $stderr = StringIO.new
    yield
  ensure
    $stdout = orig_out
    $stderr = orig_err
  end

  case method
  when "selenium"
    result = nil
    silence_output do
      result = Instaview.get_from_cache_or_async(username, max_age_hours: 12, method: :selenium)
    end
    puts JSON.pretty_generate(result)
  when "http"
    result = nil
    silence_output do
      result = Instaview.get_from_cache_or_async(username, max_age_hours: 12, method: :simple_http)
    end
    puts JSON.pretty_generate(result)
  end
rescue => e
  puts "Error: #{e.message}"
  if method == "selenium"
    puts ""
    puts "If you're having Chrome/Selenium issues, try:"
    puts "  1. Run: ./bin/setup_selenium"
    puts "  2. Or use HTTP method: instaview #{username} http"
  end
  exit 1
end